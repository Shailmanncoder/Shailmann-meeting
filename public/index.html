<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shailmann Connect - Ultimate Host Edition</title>
    
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="shortcut icon" type="image/png" href="favicon.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* * ======================================================================================
         * SECTION 1: GLOBAL VARIABLES & THEME
         * ======================================================================================
         */
        :root {
            /* --- Dark Mode Palette --- */
            --bg-app: #0f1115;
            --bg-panel: #181b21;
            --bg-element: #25282e;
            --bg-hover: #32363e;
            
            /* --- Brand Colors --- */
            --primary: #4f46e5;       /* Indigo */
            --primary-hover: #4338ca; 
            --secondary: #64748b;     /* Slate */
            --danger: #ef4444;        /* Red */
            --success: #22c55e;       /* Green */
            --warning: #f59e0b;       /* Amber */
            
            /* --- Text Colors --- */
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            
            /* --- Layout & Spacing --- */
            --sidebar-width: 320px;
            --footer-height: 80px;
            --header-height: 60px;
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 18px;
            
            /* --- Shadows --- */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* --- Reset & Base Styles --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            height: 100vh;
            /* Dynamic Viewport Height for Mobile Browsers */
            height: 100dvh; 
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- Utility Classes --- */
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-app); }
        ::-webkit-scrollbar-thumb { background: var(--bg-element); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--secondary); }

        /* * ======================================================================================
         * SECTION 2: LOBBY & ONBOARDING UI
         * ======================================================================================
         */
        #lobby-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f1115 0%, #1a1d26 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .lobby-card {
            background: var(--bg-panel);
            width: 100%;
            max-width: 480px;
            padding: 40px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--bg-hover);
            text-align: center;
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .lobby-logo {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 15px;
            text-shadow: 0 0 20px rgba(79, 70, 229, 0.3);
        }

        .lobby-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: white;
        }

        .lobby-subtitle {
            color: var(--text-muted);
            margin-bottom: 30px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Input Fields */
        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
        }

        .lobby-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-app);
            border: 1px solid var(--bg-hover);
            border-radius: var(--radius-sm);
            color: white;
            font-size: 1rem;
            transition: all 0.2s;
        }
        .lobby-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        /* Buttons */
        .btn-primary {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(1px); }

        .btn-secondary {
            width: 100%;
            padding: 14px;
            background: transparent;
            border: 1px solid var(--bg-hover);
            color: var(--text-muted);
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }
        .btn-secondary:hover { border-color: var(--text-main); color: var(--text-main); }

        /* Green Room / Preview Area */
        .preview-container {
            width: 100%;
            height: 260px;
            background: #000;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--bg-hover);
        }

        #preview-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror effect */
        }

        .preview-controls {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 30px;
            backdrop-filter: blur(8px);
        }

        .preview-btn {
            width: 45px; height: 45px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem;
            transition: all 0.2s;
        }
        .preview-btn:hover { background: rgba(255, 255, 255, 0.3); }
        .preview-btn.off { background: var(--danger); color: white; }

        /* * ======================================================================================
         * SECTION 3: MAIN APP UI
         * ======================================================================================
         */
        #app-container {
            display: flex;
            height: 100%;
            width: 100%;
            position: relative;
        }

        /* --- Main Stage (Video Area) --- */
        #main-stage {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-app);
            position: relative;
            overflow: hidden;
        }

        /* Info Badge (Room ID) */
        .room-info-badge {
            position: absolute;
            top: 20px; left: 20px;
            z-index: 50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .room-pill {
            background: rgba(24, 27, 33, 0.85);
            padding: 8px 16px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-main);
            font-family: monospace;
            font-size: 0.9rem;
            display: flex; align-items: center; gap: 8px;
            box-shadow: var(--shadow-md);
        }
        .copy-btn {
            background: none; border: none; color: var(--text-muted); cursor: pointer;
        }
        .copy-btn:hover { color: white; }

        /* Rec Indicator */
        .rec-indicator {
            background: var(--danger);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            display: flex; align-items: center; gap: 6px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

       /* =========================================================
   1. GRID VIEW (Normal Mode - Centered)
   ========================================================= */
#video-grid {
    display: flex;
    flex-wrap: wrap;
    justify-content: center; /* Keeps cameras in center */
    align-items: center;
    align-content: center;
    width: 100%;
    height: 100%;
    overflow-y: auto;
    gap: 15px;
    padding: 20px;
    transition: all 0.3s ease; /* Smooth animation */
}

/* Video Card (Normal Size) */
.video-card {
    position: relative;
    background: #25282e;
    border-radius: 12px;
    overflow: hidden;
    width: 45%; 
    max-width: 600px;
    aspect-ratio: 16/9;
    min-width: 300px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

/* =========================================================
   2. SCREEN SHARE MODE (WhatsApp Style)
   ========================================================= */

/* A. The Screen Share Area (Massive & Black) */
#dominant-view {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: #000; /* Pure Black like WhatsApp */
    z-index: 5; /* Behind the controls, but above background */
    display: none; /* Hidden by default */
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

#dominant-video {
    width: 100%;
    height: 100%;
    object-fit: contain; /* Ensures entire screen is visible */
    max-height: 100vh;
}

/* B. The "Top Strip" (Cameras move here when sharing) */
#video-grid.top-strip {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 140px; /* Fixed height strip */
    justify-content: flex-start; /* Align left */
    flex-wrap: nowrap; /* Single row */
    overflow-x: auto; /* Scrollable sideways */
    padding: 10px;
    background: rgba(0,0,0,0.6); /* Semi-transparent background */
    z-index: 20; /* Sit ON TOP of the screen share */
    align-content: center;
}

/* Shrink video cards when they are in the top strip */
#video-grid.top-strip .video-card {
    width: 180px;
    min-width: 180px;
    height: 100px;
    margin-right: 10px;
}

/* Hide the name tag in top strip to save space (Optional) */
#video-grid.top-strip .user-name-tag {
    font-size: 0.7rem;
    padding: 2px 5px;
}

/* =========================================================
   3. BOTTOM CONTROLS (Responsive)
   ========================================================= */
#controls-bar {
    height: 80px;
    background-color: #181b21;
    display: flex;
    justify-content: center; /* Center the buttons */
    align-items: center;
    gap: 15px;
    width: 100%;
    z-index: 100;
    border-top: 1px solid #333;
    padding: 0 10px;
    /* Ensure it stays at bottom even if content changes */
    position: relative; 
}

/* Mobile adjustments for controls */
@media (max-width: 768px) {
    #controls-bar {
        overflow-x: auto; /* Scroll if too many buttons */
        justify-content: space-evenly;
        padding-bottom: 10px; /* Safety padding for iPhone home bar */
    }
    .control-btn {
        width: 45px; height: 45px; flex-shrink: 0;
    }
}
        /* * ======================================================================================
         * SECTION 4: CONTROLS BAR (Footer)
         * ======================================================================================
         */
        

        .controls-left { width: 200px; display: flex; align-items: center; }
        .controls-right { width: 200px; display: flex; justify-content: flex-end; }
        
        .controls-center {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-btn {
            width: 50px; height: 50px;
            border-radius: 14px;
            border: none;
            background: var(--bg-element);
            color: var(--text-main);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        .control-btn:hover { background: var(--bg-hover); transform: translateY(-2px); }
        .control-btn:active { transform: translateY(0); }

        .control-btn.active-feature { background: var(--primary); color: white; box-shadow: 0 0 15px rgba(79, 70, 229, 0.4); }
        .control-btn.off-state { background: var(--danger); color: white; }

        .leave-btn {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            width: auto; padding: 0 24px;
            font-weight: 600;
        }
        .leave-btn:hover { background: var(--danger); color: white; }

        .notification-dot {
            position: absolute; top: 10px; right: 10px;
            width: 10px; height: 10px;
            background: var(--danger);
            border-radius: 50%;
            border: 2px solid var(--bg-element);
            display: none;
        }

        /* * ======================================================================================
         * SECTION 5: SIDEBAR (Chat & Participants)
         * ======================================================================================
         */
        #sidebar-panel {
            width: var(--sidebar-width);
            background: var(--bg-panel);
            border-left: 1px solid var(--bg-hover);
            display: none; /* Hidden by default */
            flex-direction: column;
            height: 100%;
        }

        .sidebar-header {
            height: 60px;
            border-bottom: 1px solid var(--bg-hover);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-weight: 600;
            background: var(--bg-element);
        }
        .close-sidebar-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; }

        /* Tabs */
        .tab-group {
            display: flex;
            padding: 15px;
            gap: 10px;
        }
        .tab-btn {
            flex: 1;
            padding: 8px;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: var(--radius-sm);
            font-weight: 500;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--bg-element);
            color: white;
            border-color: var(--bg-hover);
        }

        /* Chat Area */
        #chat-view {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-msg {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .chat-msg.local {
            align-self: flex-end;
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 2px;
        }
        .chat-msg.remote {
            align-self: flex-start;
            background: var(--bg-element);
            color: var(--text-main);
            border-bottom-left-radius: 2px;
        }
        .msg-meta { font-size: 0.7rem; opacity: 0.7; margin-bottom: 4px; display: block; }

        .chat-input-wrapper {
            padding: 15px;
            border-top: 1px solid var(--bg-hover);
            background: var(--bg-panel);
            display: flex; gap: 10px;
        }
        #chat-input {
            flex-grow: 1;
            background: var(--bg-app);
            border: 1px solid var(--bg-hover);
            border-radius: 20px;
            padding: 10px 15px;
            color: white;
        }
        #send-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 40px; height: 40px;
            border-radius: 50%;
            cursor: pointer;
        }

        /* * ======================================================================================
         * SECTION 6: MODALS & TOASTS
         * ======================================================================================
         */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 5000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .modal-box {
            background: var(--bg-panel);
            width: 90%; max-width: 400px;
            padding: 30px;
            border-radius: var(--radius-md);
            border: 1px solid var(--bg-hover);
            box-shadow: var(--shadow-lg);
            transform: scale(0.9); transition: transform 0.3s;
        }
        .modal-overlay.open .modal-box { transform: scale(1); }

        .toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 6000;
            display: flex; flex-direction: column; gap: 10px;
            pointer-events: none;
        }
        .toast {
            background: var(--bg-element);
            border-left: 4px solid var(--primary);
            padding: 15px 20px;
            border-radius: 6px;
            box-shadow: var(--shadow-lg);
            color: white;
            min-width: 280px;
            animation: slideInRight 0.3s ease;
            pointer-events: auto;
            display: flex; align-items: center; gap: 10px;
        }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* * ======================================================================================
         * SECTION 7: MOBILE RESPONSIVENESS (The Fixes)
         * ======================================================================================
         */
        @media (max-width: 768px) {
            /* 1. LOBBY: Full Width */
            .lobby-card { max-width: 95%; padding: 25px 20px; }
            .preview-container { height: 200px; }

            /* 2. VIDEO GRID: Vertical Stack */
            #video-grid {
                flex-direction: column;
                flex-wrap: nowrap;
                justify-content: flex-start;
                padding: 10px;
                overflow-x: hidden;
            }

            /* 3. VIDEO CARDS: Full Width on Mobile */
            .video-card {
                width: 100% !important;
                max-width: none !important;
                height: auto !important;
                aspect-ratio: 4/3 !important; /* Portrait-friendly */
                margin-bottom: 10px;
                flex-shrink: 0;
            }

            /* 4. CONTROLS: Scrollable & Optimized */
            #controls-bar {
                padding: 5px;
                justify-content: space-evenly;
                overflow-x: auto; /* Enable scroll if buttons overflow */
                -webkit-overflow-scrolling: touch;
            }
            .controls-left, .controls-right { display: none !important; } /* Hide clock */
            
            .control-btn {
                width: 42px; height: 42px;
                font-size: 1rem;
                flex-shrink: 0;
                margin: 0 4px;
            }

            /* 5. SIDEBAR: Full Screen Overlay */
            #sidebar-panel {
                position: fixed; top: 0; left: 0;
                width: 100% !important;
                height: 100% !important;
                z-index: 2000;
            }
        }
    </style>
</head>
<body>

    <div id="toast-container" class="toast-container"></div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-bottom: 20px;">Device Settings</h3>
            <div class="input-group">
                <label><i class="fas fa-microphone"></i> Microphone</label>
                <select id="audio-input-select" class="lobby-input"><option>Default</option></select>
            </div>
            <div class="input-group">
                <label><i class="fas fa-video"></i> Camera</label>
                <select id="video-input-select" class="lobby-input"><option>Default</option></select>
            </div>
            <div style="margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-secondary" onclick="closeSettings()" style="width: auto; padding: 10px 20px;">Cancel</button>
                <button class="btn-primary" onclick="saveSettings()" style="width: auto; padding: 10px 20px;">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="waiting-room-modal" class="modal-overlay">
        <div class="modal-box" style="text-align: center;">
            <div style="font-size: 3rem; color: var(--warning); margin-bottom: 10px;"><i class="fas fa-user-clock"></i></div>
            <h3>Guest Knocking</h3>
            <p id="waiting-user-name" style="color: var(--text-muted); margin: 15px 0;">A user wants to join.</p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="btn-deny-entry" class="btn-secondary" style="border-color: var(--danger); color: var(--danger);">Deny</button>
                <button id="btn-allow-entry" class="btn-primary" style="background: var(--success);">Admit</button>
            </div>
        </div>
    </div>

    <div id="lobby-container">
        
        <div id="lobby-step-1" class="lobby-card">
            <div class="lobby-logo"><i class="fas fa-cube"></i></div>
            <div class="lobby-title">Shailmann-Connect</div>
            <div class="lobby-subtitle">Secure, High-Definition Video Conferencing<br>for teachers and Modern Teams.</div>
            
            <button class="btn-primary" onclick="goToStep(2)">
                <i class="fas fa-plus-circle"></i> Create New Meeting
            </button>
            <button class="btn-secondary" onclick="goToStep(3)">
                <i class="fas fa-sign-in-alt"></i> Join Existing Meeting
            </button>
        </div>

        <div id="lobby-step-2" class="lobby-card hidden">
            <div class="lobby-title">Host Meeting</div>
            <div class="input-group">
                <label>Your Name</label>
                <input type="text" id="host-name" class="lobby-input" placeholder="e.g. Sarah Connor">
            </div>
            <div class="input-group">
                <label>Room ID (Optional)</label>
                <input type="text" id="create-room-id" class="lobby-input" placeholder="Leave empty to generate">
            </div>
            <button class="btn-primary" onclick="initHostFlow()">Continue to Preview</button>
            <button class="btn-secondary" onclick="goToStep(1)">Back</button>
        </div>

        <div id="lobby-step-3" class="lobby-card hidden">
            <div class="lobby-title">Join Meeting</div>
            <div class="input-group">
                <label>Your Name</label>
                <input type="text" id="guest-name" class="lobby-input" placeholder="e.g. John Smith">
            </div>
            <div class="input-group">
                <label>Room ID</label>
                <input type="text" id="join-room-id" class="lobby-input" placeholder="e.g. meeting-123">
            </div>
            <button class="btn-primary" onclick="initGuestFlow()">Continue to Preview</button>
            <button class="btn-secondary" onclick="goToStep(1)">Back</button>
        </div>

        <div id="lobby-step-4" class="lobby-card hidden" style="max-width: 550px;">
            <div class="lobby-title">Audio & Video Check</div>
            <p id="connection-status" style="color: var(--warning); font-size: 0.9rem; margin-bottom: 15px;">Initializing camera...</p>
            
            <div class="preview-container">
                <video id="preview-video" autoplay muted playsinline></video>
                <div class="preview-controls">
                    <button id="pre-mic-btn" class="preview-btn" title="Toggle Mic"><i class="fas fa-microphone"></i></button>
                    <button id="pre-cam-btn" class="preview-btn" title="Toggle Camera"><i class="fas fa-video"></i></button>
                    <button id="pre-set-btn" class="preview-btn" title="Settings"><i class="fas fa-cog"></i></button>
                </div>
            </div>

            <button id="btn-enter-meeting" class="btn-primary" style="background: var(--success);">
                <i class="fas fa-video"></i> Join Meeting Now
            </button>
        </div>
    </div>

    <div id="app-container" class="hidden">
        
      <div id="main-stage">
    
    <div class="room-info-badge">
        <div class="room-pill">
            <i class="fas fa-shield-alt" style="color: var(--success);"></i>
            <span id="display-room-id">...</span>
            <button class="copy-btn" onclick="copyRoomLink()" title="Copy Link"><i class="fas fa-copy"></i></button>
        </div>
        <div id="rec-status" class="rec-indicator hidden">REC</div>
    </div>

    <div id="dominant-view">
        <div class="screenshare-info" style="position: absolute; top: 20px; z-index: 60; background: rgba(0,0,0,0.6); color: white; padding: 8px 15px; border-radius: 20px;">
            <i class="fas fa-desktop"></i> <span id="sharing-user-name">User</span> is sharing screen
        </div>
        <video id="dominant-video" autoplay playsinline></video>
    </div>

    <div id="video-grid">
        <div class="video-card" id="local-card">
            <video id="local-video" autoplay muted playsinline></video>
            
            <div class="no-cam-placeholder hidden" id="local-placeholder">
                <div class="avatar-circle">You</div>
                <div style="color: var(--text-muted);">Camera Off</div>
            </div>
            
            <div class="user-name-tag">
                <i class="fas fa-microphone-slash" id="local-mute-icon" style="color: var(--danger); display: none;"></i>
                You
            </div>
        </div>
        </div>

    <div id="reaction-area" style="position: absolute; bottom: 100px; left: 0; width: 100%; height: 200px; pointer-events: none; overflow: hidden; z-index: 90;"></div>

</div>

        <div id="sidebar-panel">
            <div class="sidebar-header">
                <span>Meeting Details</span>
                <button class="close-sidebar-btn" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchTab('chat')"><i class="fas fa-comment-dots"></i> Chat</button>
                <button class="tab-btn" onclick="switchTab('participants')"><i class="fas fa-users"></i> People <span id="p-count" style="font-size: 0.8rem; background: var(--bg-hover); padding: 2px 6px; border-radius: 10px;">1</span></button>
            </div>

            <div id="chat-view">
                <div id="chat-messages">
                    <div style="text-align: center; color: var(--text-muted); font-size: 0.85rem; margin-top: 20px;">
                        <i class="fas fa-lock"></i> Messages are end-to-end encrypted via WebRTC.
                    </div>
                </div>
                <div class="chat-input-wrapper">
                    <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off">
                    <button id="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>

            <div id="participants-view" class="hidden" style="padding: 15px;">
                <div id="participants-list">
                    </div>
            </div>
        </div>

        <div id="controls-bar">
            <div class="controls-left">
                <span id="clock-display" style="font-weight: 500; font-family: monospace; color: var(--text-muted);">00:00</span>
            </div>
            
            <div class="controls-center">
                <button id="mic-btn" class="control-btn" title="Toggle Microphone">
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="cam-btn" class="control-btn" title="Toggle Camera">
                    <i class="fas fa-video"></i>
                </button>
                <button id="screen-btn" class="control-btn" title="Share Screen">
                    <i class="fas fa-desktop"></i>
                </button>
                <button id="record-btn" class="control-btn" title="Record Meeting">
                    <i class="fas fa-record-vinyl"></i>
                </button>
                <button id="reaction-btn" class="control-btn" title="Send Reaction">
                    <i class="fas fa-smile"></i>
                </button>
                
                <button class="control-btn" onclick="toggleSidebar()" title="Open Chat">
                    <i class="fas fa-comment-alt"></i>
                    <div class="notification-dot" id="chat-notify"></div>
                </button>

                <button class="control-btn leave-btn" onclick="leaveMeeting()" title="End Call">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>

            <div class="controls-right"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        /**
         * ======================================================================================
         * GLOBAL CONFIGURATION & STATE
         * ======================================================================================
         */
        
        // Robust STUN Servers (Fixes connection issues between WiFi/Data)
        const CONFIG = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun.nextcloud.com:443' }
            ]
        };

        // Application State
        const state = {
            localStream: null,
            screenStream: null,
            mediaRecorder: null,
            recordedChunks: [],
            isRecording: false,
            isScreenSharing: false,
            isHost: false,          // Critical Flag
            roomId: null,
            userName: "User",
            peerConnections: {},    // WebRTC Connections
            dataChannels: {},       // Chat Channels
            peers: {},              // User Metadata
            audioEnabled: true,
            videoEnabled: true
        };

        const socket = io();

        // DOM Element Cache for Performance
        const els = {
            lobby: document.getElementById('lobby-container'),
            app: document.getElementById('app-container'),
            videoGrid: document.getElementById('video-grid'),
            dominantView: document.getElementById('dominant-view'),
            localVideo: document.getElementById('local-video'),
            previewVideo: document.getElementById('preview-video'),
            chatInput: document.getElementById('chat-input'),
            chatMsgs: document.getElementById('chat-messages'),
            status: document.getElementById('connection-status')
        };

        // Clock
        setInterval(() => {
            document.getElementById('clock-display').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }, 1000);

        /**
         * ======================================================================================
         * 1. LOBBY & INITIALIZATION FLOWS
         * ======================================================================================
         */

        function goToStep(step) {
            document.querySelectorAll('.lobby-card').forEach(el => el.classList.add('hidden'));
            document.getElementById(`lobby-step-${step}`).classList.remove('hidden');
        }

        // --- HOST FLOW (FIXED) ---
        async function initHostFlow() {
            const name = document.getElementById('host-name').value.trim();
            const room = document.getElementById('create-room-id').value.trim() || Math.random().toString(36).substring(7);

            if(!name) { alert("Please enter your name."); return; }

            // 1. Set Critical State
            state.userName = name;
            state.roomId = room;
            state.isHost = true; // HOST FLAG

            els.status.innerText = `Preparing Room: ${room}...`;
            els.status.style.color = 'var(--warning)';

            // 2. Get Media
            try {
                await setupMedia(); // Forces Permission Popup
                goToStep(4);
                els.status.innerText = "Camera Ready. Join when ready.";
                els.status.style.color = 'var(--success)';
            } catch (e) {
                console.error(e);
                alert("Camera access failed: " + e.message);
            }
        }

        // --- GUEST FLOW (FIXED) ---
        async function initGuestFlow() {
            const name = document.getElementById('guest-name').value.trim();
            const room = document.getElementById('join-room-id').value.trim();

            if(!name || !room) { alert("Please enter Name and Room ID."); return; }

            // 1. Set Critical State
            state.userName = name;
            state.roomId = room;
            state.isHost = false; // GUEST FLAG (Fixed)

            els.status.innerText = `Connecting to ${room}...`;
            
            // 2. Get Media
            try {
                await setupMedia(); // Forces Permission Popup
                goToStep(4);
            } catch (e) {
                alert("You must allow Camera access to join.");
            }
        }

        // --- MEDIA SETUP (ROBUST) ---
        async function setupMedia() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                state.localStream = stream;
                
                // Show in Preview
                if (els.previewVideo) els.previewVideo.srcObject = stream;

                // Populate Settings (Try/Catch for mobile safety)
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const audioSelect = document.getElementById('audio-input-select');
                    const videoSelect = document.getElementById('video-input-select');
                    
                    audioSelect.innerHTML = '<option>Default</option>';
                    videoSelect.innerHTML = '<option>Default</option>';

                    devices.forEach(d => {
                        const opt = document.createElement('option');
                        opt.value = d.deviceId;
                        opt.text = d.label || d.kind;
                        if(d.kind === 'audioinput') audioSelect.appendChild(opt);
                        else if(d.kind === 'videoinput') videoSelect.appendChild(opt);
                    });
                } catch(e) { console.warn("Device enumeration limited"); }

                return true;
            } catch (err) {
                throw err;
            }
        }

        /**
         * ======================================================================================
         * 2. JOINING LOGIC (HOST VS GUEST)
         * ======================================================================================
         */
        document.getElementById('btn-enter-meeting').onclick = () => {
            els.localVideo.srcObject = state.localStream;
            
            els.lobby.classList.add('hidden');
            els.app.classList.remove('hidden');
            document.getElementById('display-room-id').innerText = state.roomId;

            // Enable Refresh Protection
            enableRefreshProtection();

            if (state.isHost) {
                // Host Joins Directly
                socket.emit('join-room', { roomId: state.roomId, userName: state.userName, isHost: true });
                addParticipantToList(socket.id, state.userName + " (You)", true);
                showToast("You created the meeting", "success");
            } else {
                // Guest Requests Entry
                showToast("Waiting for Host approval...", "warning");
                socket.emit('request-entry', { roomId: state.roomId, userName: state.userName });
            }
        };

        /**
         * ======================================================================================
         * 3. SOCKET.IO EVENTS
         * ======================================================================================
         */

        // Host Logic: Handle Knocking
        socket.on('entry-requested', (data) => {
            if(!state.isHost) return;
            
            const modal = document.getElementById('waiting-room-modal');
            document.getElementById('waiting-user-name').innerText = `${data.userName} wants to join.`;
            modal.classList.add('open');

            document.getElementById('btn-allow-entry').onclick = () => {
                socket.emit('admin-action', { action: 'approve', targetId: data.socketId });
                modal.classList.remove('open');
            };
            document.getElementById('btn-deny-entry').onclick = () => {
                socket.emit('admin-action', { action: 'deny', targetId: data.socketId });
                modal.classList.remove('open');
            };
        });

        // Guest Logic: Handle Approval
        socket.on('entry-approved', () => {
            showToast("Entry Approved!", "success");
            socket.emit('join-room-final', { roomId: state.roomId, userName: state.userName });
        });
        socket.on('entry-denied', () => {
            alert("Host denied your entry.");
            window.location.href = "/";
        });

        // Connection Handling
        socket.on('user-connected', (userId, userName) => {
            showToast(`${userName} joined`, "info");
            state.peers[userId] = { name: userName };
            addParticipantToList(userId, userName, false);
            // Initiate WebRTC Call
            connectToNewUser(userId);
        });

        socket.on('user-disconnected', (userId) => {
            const name = state.peers[userId]?.name || "User";
            showToast(`${name} left`, "warning");
            
            if(state.peerConnections[userId]) state.peerConnections[userId].close();
            delete state.peerConnections[userId];
            delete state.dataChannels[userId];
            
            // Cleanup UI
            const el = document.getElementById(`wrapper-${userId}`);
            if(el) el.remove();
            removeParticipantFromList(userId);
        });

        // WebRTC Signaling
        socket.on('offer', async (offer, userId, userName) => {
            state.peers[userId] = { name: userName };
            addParticipantToList(userId, userName, false);

            const pc = createPeerConnection(userId);
            await pc.setRemoteDescription(offer);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.emit('answer', answer, userId);
        });

        socket.on('answer', async (answer, userId) => {
            const pc = state.peerConnections[userId];
            if(pc) await pc.setRemoteDescription(answer);
        });

        socket.on('candidate', async (candidate, userId) => {
            const pc = state.peerConnections[userId];
            if(pc) await pc.addIceCandidate(candidate);
        });

        /**
         * ======================================================================================
         * 4. WEBRTC & DATA CHANNELS (CHAT)
         * ======================================================================================
         */
        
        function createPeerConnection(userId) {
            const pc = new RTCPeerConnection(CONFIG);
            state.peerConnections[userId] = pc;

            // Add Local Stream
            state.localStream.getTracks().forEach(track => pc.addTrack(track, state.localStream));

            // Handle Incoming Stream
            pc.ontrack = (event) => {
                addRemoteVideo(userId, event.streams[0]);
            };

            // Handle ICE
            pc.onicecandidate = (event) => {
                if(event.candidate) socket.emit('candidate', event.candidate, userId);
            };

            // INCOMING CHAT CHANNEL (Receive)
            pc.ondatachannel = (event) => {
                const receiveChannel = event.channel;
                receiveChannel.onmessage = (e) => {
                    const sender = state.peers[userId]?.name || "Guest";
                    // Only handle if it's text, not reaction
                    if(e.data.startsWith("REACTION:")) {
                        showFloatingReaction(e.data.split(":")[1]);
                    } else {
                        addChatMessage(sender, e.data, false);
                        notifyChat();
                    }
                };
                state.dataChannels[userId] = receiveChannel;
            };

            return pc;
        }

        function connectToNewUser(userId) {
            const pc = createPeerConnection(userId);

            // OUTGOING CHAT CHANNEL (Send)
            const dc = pc.createDataChannel("chat");
            dc.onopen = () => { state.dataChannels[userId] = dc; };
            dc.onmessage = (e) => {
                 // Backup listener
                 if(e.data.startsWith("REACTION:")) showFloatingReaction(e.data.split(":")[1]);
                 else addChatMessage(state.peers[userId]?.name, e.data, false);
            };

            pc.createOffer().then(offer => {
                pc.setLocalDescription(offer);
                socket.emit('offer', offer, userId, state.userName);
            });
        }

        /**
         * ======================================================================================
         * 5. UI GENERATION (VIDEOS, CHAT, PARTICIPANTS)
         * ======================================================================================
         */

        function addRemoteVideo(userId, stream) {
            if(document.getElementById(`wrapper-${userId}`)) return;

            const name = state.peers[userId]?.name || "User";
            const wrapper = document.createElement('div');
            wrapper.className = 'video-card';
            wrapper.id = `wrapper-${userId}`;
            
            wrapper.innerHTML = `
                <video id="vid-${userId}" autoplay playsinline></video>
                <div class="no-cam-placeholder hidden" id="ph-${userId}">
                    <div class="avatar-circle">${name.charAt(0)}</div>
                </div>
                <div class="user-name-tag">${name}</div>
            `;
            
            els.videoGrid.appendChild(wrapper);
            const vid = document.getElementById(`vid-${userId}`);
            vid.srcObject = stream;
            
            // AUTOPLAY FORCE FIX
            vid.onloadedmetadata = () => {
                vid.play().catch(e => {
                    console.warn("Autoplay blocked, muting");
                    vid.muted = true; vid.play();
                });
            };

            // Monitor Track Status (Cam off/on)
            const videoTrack = stream.getVideoTracks()[0];
            if(videoTrack) {
                videoTrack.onmute = () => document.getElementById(`ph-${userId}`).classList.remove('hidden');
                videoTrack.onunmute = () => document.getElementById(`ph-${userId}`).classList.add('hidden');
                // Initial check
                if(!videoTrack.enabled) document.getElementById(`ph-${userId}`).classList.remove('hidden');
            }
        }

        // --- Chat Logic ---
        function sendMessage() {
            const text = els.chatInput.value.trim();
            if(!text) return;
            
            addChatMessage("You", text, true);
            
            // Send to all connected peers
            Object.values(state.dataChannels).forEach(dc => {
                if(dc.readyState === 'open') dc.send(text);
            });
            
            els.chatInput.value = '';
        }

        els.chatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });

        function addChatMessage(sender, text, isLocal) {
            const bubble = document.createElement('div');
            bubble.className = `chat-msg ${isLocal ? 'local' : 'remote'}`;
            bubble.innerHTML = `<span class="msg-meta">${sender}</span>${text}`;
            els.chatMsgs.appendChild(bubble);
            els.chatMsgs.scrollTop = els.chatMsgs.scrollHeight;
        }

        function notifyChat() {
            if(document.getElementById('sidebar-panel').style.display !== 'flex') {
                document.getElementById('chat-notify').style.display = 'block';
            }
        }

        // --- Participant List ---
        function addParticipantToList(id, name, isLocal) {
            const list = document.getElementById('participants-list');
            const item = document.createElement('div');
            item.id = `plist-${id}`;
            item.style.padding = "10px";
            item.style.borderBottom = "1px solid var(--bg-hover)";
            item.style.display = "flex";
            item.style.justifyContent = "space-between";
            item.innerHTML = `
                <span>${name}</span>
                ${state.isHost && !isLocal ? `<button onclick="kickUser('${id}')" style="color:var(--danger);background:none;border:none;cursor:pointer;">Kick</button>` : ''}
            `;
            list.appendChild(item);
            document.getElementById('p-count').innerText = list.children.length;
        }

        function removeParticipantFromList(id) {
            const el = document.getElementById(`plist-${id}`);
            if(el) el.remove();
            document.getElementById('p-count').innerText = document.getElementById('participants-list').children.length;
        }

        /**
         * ======================================================================================
         * 6. CONTROLS (MIC, CAM, SCREEN, REC, REFRESH)
         * ======================================================================================
         */

        // --- Toggle Mic ---
        document.getElementById('mic-btn').onclick = () => {
            const track = state.localStream.getAudioTracks()[0];
            state.audioEnabled = !state.audioEnabled;
            track.enabled = state.audioEnabled;
            
            const btn = document.getElementById('mic-btn');
            btn.innerHTML = state.audioEnabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
            btn.classList.toggle('off-state', !state.audioEnabled);
            
            document.getElementById('local-mute-icon').style.display = state.audioEnabled ? 'none' : 'inline-block';
        };

        // --- Toggle Cam ---
        document.getElementById('cam-btn').onclick = () => {
            const track = state.localStream.getVideoTracks()[0];
            state.videoEnabled = !state.videoEnabled;
            track.enabled = state.videoEnabled;
            
            const btn = document.getElementById('cam-btn');
            btn.innerHTML = state.videoEnabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
            btn.classList.toggle('off-state', !state.videoEnabled);
            
            document.getElementById('local-placeholder').classList.toggle('hidden', state.videoEnabled);
        };

        // --- Screen Share ---
        document.getElementById('screen-btn').onclick = async () => {
            if (!state.isScreenSharing) {
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    state.screenStream = stream;
                    const screenTrack = stream.getVideoTracks()[0];
                    
                    // Replace tracks for all peers
                    for(let id in state.peerConnections) {
                        const sender = state.peerConnections[id].getSenders().find(s => s.track.kind === 'video');
                        if(sender) sender.replaceTrack(screenTrack);
                    }

                    socket.emit('start-screen-share', state.roomId);
                    updateScreenShareUI(true, stream, "You are");
                    document.getElementById('screen-btn').classList.add('active-feature');
                    state.isScreenSharing = true;
                    
                    screenTrack.onended = stopScreenShare;
                } catch(e) { console.log("Share cancelled"); }
            } else {
                stopScreenShare();
            }
        };

        function stopScreenShare() {
            state.screenStream.getTracks().forEach(t => t.stop());
            const camTrack = state.localStream.getVideoTracks()[0];
            
            for(let id in state.peerConnections) {
                const sender = state.peerConnections[id].getSenders().find(s => s.track.kind === 'video');
                if(sender) sender.replaceTrack(camTrack);
            }
            
            socket.emit('stop-screen-share', state.roomId);
            updateScreenShareUI(false);
            document.getElementById('screen-btn').classList.remove('active-feature');
            state.isScreenSharing = false;
        }

        socket.on('screen-share-started', (userId) => {
            const vid = document.getElementById(`vid-${userId}`);
            if(vid) updateScreenShareUI(true, vid.srcObject, state.peers[userId]?.name);
        });
        socket.on('screen-share-stopped', () => updateScreenShareUI(false));

   function updateScreenShareUI(isActive, stream = null, name = "") {
    const grid = document.getElementById('video-grid');
    const dominant = document.getElementById('dominant-view');
    const domVideo = document.getElementById('dominant-video');
    const nameLabel = document.getElementById('sharing-user-name');

    if (isActive) {
        // 1. ENABLE SCREEN SHARE MODE
        
        // Show the Big Black Screen
        dominant.style.display = 'flex';
        domVideo.srcObject = stream;
        
        // Update the badge text
        if(nameLabel) nameLabel.innerText = name;

        // MOVE CAMERAS TO TOP
        grid.classList.add('top-strip'); // This triggers the CSS to shrink them
        
    } else {
        // 2. DISABLE SCREEN SHARE MODE (Back to Normal)
        
        // Hide Big Screen
        dominant.style.display = 'none';
        domVideo.srcObject = null;

        // MOVE CAMERAS BACK TO CENTER
        grid.classList.remove('top-strip'); 
    }
}

        // --- Refresh Protection ---
        function handleRefreshWarning(e) { e.preventDefault(); e.returnValue = ''; return ""; }
        function enableRefreshProtection() { window.addEventListener('beforeunload', handleRefreshWarning); }
        function disableRefreshProtection() { window.removeEventListener('beforeunload', handleRefreshWarning); }

        function leaveMeeting() {
            if(confirm("End call?")) {
                disableRefreshProtection();
                window.location.href = '/';
            }
        }

        // --- Utils: Toggle Sidebar, Toast, Copy ---
        function toggleSidebar() {
            const sb = document.getElementById('sidebar-panel');
            sb.style.display = sb.style.display === 'flex' ? 'none' : 'flex';
            if(sb.style.display === 'flex') document.getElementById('chat-notify').style.display = 'none';
        }
        function switchTab(tab) {
            document.getElementById('chat-view').classList.add('hidden');
            document.getElementById('participants-view').classList.add('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`${tab}-view`).classList.remove('hidden');
            event.target.closest('.tab-btn').classList.add('active');
        }
        function showToast(msg, type) {
            const t = document.createElement('div');
            t.className = 'toast';
            t.style.borderLeftColor = `var(--${type})`;
            t.innerHTML = `<i class="fas fa-info-circle"></i> ${msg}`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
        function copyRoomLink() {
            navigator.clipboard.writeText(window.location.origin + "/?room=" + state.roomId);
            showToast("Link copied!", "success");
        }

        // --- Settings Modal ---
        document.getElementById('pre-set-btn').onclick = () => document.getElementById('settings-modal').classList.add('open');
        function closeSettings() { document.getElementById('settings-modal').classList.remove('open'); }
        async function saveSettings() {
            const aid = document.getElementById('audio-input-select').value;
            const vid = document.getElementById('video-input-select').value;
            const stream = await navigator.mediaDevices.getUserMedia({ audio: {deviceId: aid}, video: {deviceId: vid} });
            state.localStream = stream;
            els.localVideo.srcObject = stream;
            els.previewVideo.srcObject = stream;
            closeSettings();
        }
        
        // --- Reactions ---
        document.getElementById('reaction-btn').onclick = () => {
            showFloatingReaction('');
            Object.values(state.dataChannels).forEach(dc => { if(dc.readyState==='open') dc.send("REACTION:"); });
        }
        function showFloatingReaction(emoji) {
            const el = document.createElement('div');
            el.innerText = emoji;
            el.style.position = 'absolute';
            el.style.left = Math.random() * 80 + 10 + '%';
            el.style.bottom = '0';
            el.style.fontSize = '2rem';
            el.style.animation = 'floatUp 2s ease-out forwards';
            document.getElementById('reaction-area').appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }
        // Add float animation
        const style = document.createElement('style');
        style.innerHTML = `@keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-150px); } }`;
        document.head.appendChild(style);

    </script>
</body>
</html>