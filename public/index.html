<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shailmann Connect - Ultra Host Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
   <link rel="icon" type="image/png" href="../Gemini_Generated_Image_r2dtr8r2dtr8r2dt.png">
    <style>
        /* * ======================================================================================
         * SECTION 1: CSS VARIABLES & RESET
         * ======================================================================================
         */
        :root {
            /* Color Palette - Dark Theme (Enterprise) */
            --bg-app: #0f1115;
            --bg-panel: #181b21;
            --bg-element: #25282e;
            --bg-hover: #32363e;
            
            /* Brand Colors */
            --primary: #4f46e5;       /* Indigo 600 */
            --primary-hover: #4338ca; /* Indigo 700 */
            --danger: #ef4444;        /* Red 500 */
            --success: #22c55e;       /* Green 500 */
            --warning: #eab308;       /* Yellow 500 */
            
            /* Text Colors */
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --text-dark: #111827;
            
            /* Borders & Shadows */
            --border: #374151;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --shadow-lg: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
            
            /* Layout Dimensions */
            --header-height: 60px;
            --footer-height: 80px;
            --sidebar-width: 320px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-app); }
        ::-webkit-scrollbar-thumb { background: var(--bg-element); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }

        /* * ======================================================================================
         * SECTION 2: LOBBY & ONBOARDING STYLES
         * ======================================================================================
         */
        #lobby-container {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0f1115 0%, #1a1d26 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lobby-card {
            background: var(--bg-panel);
            width: 450px;
            max-width: 90%;
            padding: 40px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            text-align: center;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .lobby-logo {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .lobby-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 25px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .lobby-input {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-app);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: white;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        .lobby-input:focus { border-color: var(--primary); outline: none; }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-primary:hover { background: var(--primary-hover); }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            margin-top: 10px;
        }
        .btn-secondary:hover { border-color: var(--text-main); color: var(--text-main); }

        /* Ready Room Preview */
        .preview-container {
            width: 100%;
            height: 240px;
            background: #000;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        #preview-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        .preview-overlay {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .preview-btn {
            width: 45px; height: 45px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            cursor: pointer;
            backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
        }
        .preview-btn.off { background: var(--danger); }

        /* * ======================================================================================
         * SECTION 3: MAIN APPLICATION LAYOUT
         * ======================================================================================
         */
        #app-container {
            display: flex;
            flex-direction: row;
            height: 100%;
            width: 100%;
            position: relative;
        }

        /* --- Main Stage (Video Area) --- */
        #main-stage {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-app);
            position: relative;
            padding: 10px;
        }

        #video-grid {
            flex-grow: 1;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 20px;
            overflow-y: auto;
            align-content: center;
        }

        /* --- Video Card Styling --- */
        .video-card {
            position: relative;
            background: var(--bg-element);
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid transparent;
            transition: all 0.3s ease;
            width: 400px;
            height: 250px;
        }
        
        .video-card.speaking { border-color: var(--success); box-shadow: 0 0 15px rgba(34, 197, 94, 0.4); }

        .video-card video {
            width: 100%; height: 100%;
            object-fit: cover;
        }

        /* Avatar / No Camera Placeholder */
        .no-cam-placeholder {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: var(--bg-element);
            z-index: 1;
            display: none; /* Hidden by default */
        }
        .no-cam-avatar {
            width: 80px; height: 80px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            font-size: 2rem;
            display: flex; align-items: center; justify-content: center;
            margin-bottom: 10px;
        }

        .user-info-badge {
            position: absolute;
            bottom: 10px; left: 10px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: white;
            z-index: 10;
            display: flex; align-items: center; gap: 6px;
        }

        /* --- Dominant Screen Share --- */
        #dominant-view {
            width: 100%;
            height: 100%;
            background: #000;
            display: none;
            position: relative;
            border-radius: var(--radius-md);
            overflow: hidden;
        }
        #dominant-video { width: 100%; height: 100%; object-fit: contain; }
        
        .sharing-indicator {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: var(--success); color: white;
            padding: 8px 16px; border-radius: 20px; font-weight: 600;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 20;
        }

        /* * ======================================================================================
         * SECTION 4: CONTROL BAR
         * ======================================================================================
         */
        #controls-bar {
            height: var(--footer-height);
            background-color: var(--bg-panel);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            border-top: 1px solid var(--border);
            z-index: 100;
        }

        .controls-left, .controls-right { display: flex; gap: 10px; width: 200px; }
        .controls-center { display: flex; gap: 15px; }
        .controls-right { justify-content: flex-end; }

        .control-btn {
            width: 50px; height: 50px;
            border-radius: 12px;
            border: none;
            background: var(--bg-element);
            color: var(--text-main);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .control-btn:hover { background: var(--bg-hover); transform: translateY(-2px); }
        
        .control-btn.active-state { background: var(--bg-element); color: var(--text-main); }
        .control-btn.off-state { background: var(--danger); color: white; }
        .control-btn.active-feature { background: var(--primary); color: white; }

        .leave-btn { background: #3f1a1a; color: var(--danger); width: auto; padding: 0 25px; }
        .leave-btn:hover { background: var(--danger); color: white; }

        .notification-badge {
            position: absolute; top: -5px; right: -5px;
            background: var(--danger); color: white;
            font-size: 0.7rem; padding: 2px 6px;
            border-radius: 10px; display: none;
        }

        /* * ======================================================================================
         * SECTION 5: SIDEBAR (CHAT & PARTICIPANTS)
         * ======================================================================================
         */
        #sidebar-panel {
            width: var(--sidebar-width);
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: none; /* Hidden by default */
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            height: 60px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-weight: 600;
        }

        .tab-switcher {
            display: flex;
            padding: 10px;
            gap: 10px;
            background: var(--bg-panel);
        }
        .tab-btn {
            flex: 1; padding: 8px;
            background: transparent; border: none;
            color: var(--text-muted); cursor: pointer;
            border-radius: var(--radius-sm);
            font-weight: 500;
        }
        .tab-btn.active { background: var(--bg-element); color: var(--text-main); }

        /* Chat Styles */
        #chat-container { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .chat-bubble {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
        }
        .chat-bubble.local { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .chat-bubble.remote { align-self: flex-start; background: var(--bg-element); border-bottom-left-radius: 2px; }
        
        .chat-meta { font-size: 0.7rem; margin-bottom: 4px; opacity: 0.8; }
        
        .chat-input-area {
            padding: 15px; border-top: 1px solid var(--border);
            display: flex; gap: 10px;
        }
        #chat-input {
            flex-grow: 1; background: var(--bg-app); border: 1px solid var(--border);
            padding: 10px; border-radius: 20px; color: white;
        }

        /* Participant List Styles */
        #participants-list { padding: 10px; overflow-y: auto; }
        .participant-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; border-radius: 8px;
            transition: background 0.2s;
        }
        .participant-item:hover { background: var(--bg-element); }
        .p-name { display: flex; align-items: center; gap: 10px; font-weight: 500; }
        .p-avatar { width: 32px; height: 32px; background: var(--bg-hover); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; }
        .p-actions button { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 5px; }
        .p-actions button:hover { color: var(--danger); }

        /* * ======================================================================================
         * SECTION 6: MODALS & TOASTS
         * ======================================================================================
         */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        .modal-box {
            background: var(--bg-panel); width: 400px; padding: 25px;
            border-radius: var(--radius-md); border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
        }

        .toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 5000;
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            background: var(--bg-element); border-left: 4px solid var(--primary);
            padding: 15px 20px; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            color: white; min-width: 250px; animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* * ======================================================================================
         * SECTION 7: RESPONSIVE & UTILITY
         * ======================================================================================
         */
        @media (max-width: 768px) {
            #sidebar-panel { position: fixed; right: 0; height: calc(100% - 80px); z-index: 200; }
            #video-grid .video-card { width: 100%; height: 200px; }
            .controls-center { gap: 8px; }
            .control-btn { width: 40px; height: 40px; font-size: 1rem; }
            #lobby-container .lobby-card { width: 95%; padding: 20px; }
        }
    </style>
</head>
<body>

    <div id="toast-container" class="toast-container"></div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-bottom: 20px;">Audio & Video Settings</h3>
            <div class="input-group">
                <label>Microphone</label>
                <select id="audio-input-select" class="lobby-input"><option>Default Microphone</option></select>
            </div>
            <div class="input-group">
                <label>Camera</label>
                <select id="video-input-select" class="lobby-input"><option>Default Camera</option></select>
            </div>
            <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn-secondary" onclick="closeSettings()" style="width: auto; padding: 8px 16px;">Cancel</button>
                <button class="btn-primary" onclick="saveSettings()" style="width: auto; padding: 8px 16px;">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="waiting-room-modal" class="modal-overlay">
        <div class="modal-box">
            <h3><i class="fas fa-user-lock"></i> Waiting Room Request</h3>
            <p id="waiting-user-name" style="margin: 15px 0; color: var(--text-muted);">User wants to join...</p>
            <div style="display: flex; gap: 10px;">
                <button id="btn-deny-entry" class="btn-secondary" style="border-color: var(--danger); color: var(--danger);">Deny</button>
                <button id="btn-allow-entry" class="btn-primary" style="background: var(--success);">Admit</button>
            </div>
        </div>
    </div>

    <div id="lobby-container">
        
        <div id="lobby-step-1" class="lobby-card">
            <div class="lobby-logo"><i class="fas fa-network-wired"></i></div>
            <div class="lobby-title">Shailmann-Connect</div>
            <p style="color: var(--text-muted); margin-bottom: 30px;">Secure, high-definition video conferencing for teachers and professional.</p>
            
            <button class="btn-primary" onclick="goToStep(2)">Create New Meeting</button>
            <button class="btn-secondary" onclick="goToStep(3)" style="width: 100%; padding: 14px;">Join Meeting</button>
        </div>

        <div id="lobby-step-2" class="lobby-card hidden">
            <div class="lobby-title">Host a Session</div>
            <div class="input-group">
                <label>Your Name</label>
                <input type="text" id="host-name" class="lobby-input" placeholder="e.g. John Doe">
            </div>
            <div class="input-group">
                <label>Room ID (Optional)</label>
                <input type="text" id="create-room-id" class="lobby-input" placeholder="Auto-generated if empty">
            </div>
            <button class="btn-primary" onclick="initHostFlow()">Generate Room</button>
            <button class="btn-secondary" onclick="goToStep(1)">Back</button>
        </div>

        <div id="lobby-step-3" class="lobby-card hidden">
            <div class="lobby-title">Join Session</div>
            <div class="input-group">
                <label>Your Name</label>
                <input type="text" id="guest-name" class="lobby-input" placeholder="e.g. Jane Smith">
            </div>
            <div class="input-group">
                <label>Room ID</label>
                <input type="text" id="join-room-id" class="lobby-input" placeholder="e.g. meeting-123">
            </div>
            <button class="btn-primary" onclick="initGuestFlow()">Connect</button>
            <button class="btn-secondary" onclick="goToStep(1)">Back</button>
        </div>

        <div id="lobby-step-4" class="lobby-card hidden" style="width: 500px;">
            <div class="lobby-title">Audio & Video Check</div>
            
            <div class="preview-container">
                <video id="preview-video" autoplay muted playsinline></video>
                <div class="preview-overlay">
                    <button id="pre-mic-btn" class="preview-btn"><i class="fas fa-microphone"></i></button>
                    <button id="pre-cam-btn" class="preview-btn"><i class="fas fa-video"></i></button>
                    <button id="pre-set-btn" class="preview-btn"><i class="fas fa-cog"></i></button>
                </div>
            </div>

            <div id="connection-status" style="margin-bottom: 15px; font-size: 0.9rem; color: var(--warning);">
                Checking permissions...
            </div>

            <button id="btn-enter-meeting" class="btn-primary">Join Meeting Now</button>
        </div>
    </div>

    <div id="app-container" class="hidden">
        
        <div id="main-stage">
            
            <div style="position: absolute; top: 20px; left: 20px; z-index: 50; display: flex; align-items: center; gap: 15px;">
                <div style="background: rgba(0,0,0,0.5); padding: 8px 15px; border-radius: 20px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1);">
                    <i class="fas fa-shield-alt" style="color: var(--success); margin-right: 5px;"></i>
                    <span id="display-room-id" style="font-weight: 500; font-family: monospace;">ROOM-ID</span>
                    <button onclick="copyRoomLink()" style="background: none; border: none; color: white; margin-left: 10px; cursor: pointer;"><i class="fas fa-copy"></i></button>
                </div>
                <div id="recording-indicator" class="hidden" style="background: var(--danger); padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 0.85rem;">
                    <div style="width: 8px; height: 8px; background: white; border-radius: 50%; animation: blink 1s infinite;"></div>
                    REC
                </div>
            </div>

            <div id="dominant-view">
                <div class="sharing-indicator">
                    <i class="fas fa-desktop" style="margin-right: 8px;"></i> <span id="sharing-user-name">User</span> is presenting
                </div>
                <video id="dominant-video" autoplay playsinline></video>
                <button onclick="togglePip()" style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); border: none; color: white; padding: 10px; border-radius: 8px; cursor: pointer; z-index: 50;">
                    <i class="fas fa-expand-alt"></i>
                </button>
            </div>

            <div id="video-grid">
                <div class="video-card" id="local-card">
                    <video id="local-video" autoplay muted playsinline></video>
                    <div class="no-cam-placeholder">
                        <div class="no-cam-avatar">You</div>
                        <div style="color: var(--text-muted);">Camera Off</div>
                    </div>
                    <div class="user-info-badge">
                        <i class="fas fa-microphone-slash" id="local-mute-icon" style="color: var(--danger); display: none;"></i>
                        You (Host)
                    </div>
                </div>
            </div>

            <div id="reactions-container" style="position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); pointer-events: none; height: 200px; width: 100%;"></div>

        </div>

        <div id="sidebar-panel">
            <div class="sidebar-header">
                <span>Meeting Details</span>
                <button onclick="toggleSidebar()" style="background: none; border: none; color: var(--text-muted); cursor: pointer;"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="tab-switcher">
                <button class="tab-btn active" onclick="switchTab('chat')"><i class="fas fa-comment-alt"></i> Chat</button>
                <button class="tab-btn" onclick="switchTab('participants')"><i class="fas fa-users"></i> People <span id="participant-count" style="background: var(--bg-element); padding: 2px 6px; border-radius: 10px; font-size: 0.7rem;">1</span></button>
            </div>

            <div id="chat-container">
                <div id="chat-messages">
                    <div style="text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-top: 20px;">
                        Messages are encrypted and ephemeral.
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-input" placeholder="Type a message...">
                    <button onclick="sendMessage()" style="background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>

            <div id="participants-list" class="hidden">
                </div>
        </div>

        <div id="controls-bar">
            <div class="controls-left">
                <span id="clock-display" style="font-weight: 500; color: var(--text-muted);">12:00 PM</span>
            </div>
            
            <div class="controls-center">
                <button id="mic-btn" class="control-btn" title="Toggle Microphone">
                    <i class="fas fa-microphone"></i>
                </button>
                <button id="cam-btn" class="control-btn" title="Toggle Camera">
                    <i class="fas fa-video"></i>
                </button>
                <button id="screen-btn" class="control-btn" title="Share Screen">
                    <i class="fas fa-desktop"></i>
                </button>
                <button id="record-btn" class="control-btn" title="Start Recording">
                    <i class="fas fa-record-vinyl"></i>
                </button>
                <button id="reaction-btn" class="control-btn" title="Send Reaction">
                    <i class="fas fa-smile"></i>
                </button>
                <button class="control-btn leave-btn" onclick="leaveMeeting()">
                    <i class="fas fa-phone-slash"></i> End
                </button>
            </div>

            <div class="controls-right">
                <button class="control-btn" onclick="toggleSidebar()" title="Chat / Participants">
                    <i class="fas fa-bars"></i>
                    <div class="notification-badge" id="chat-badge">0</div>
                </button>
            </div>
        </div>

    </div>

    <script src="/socket.io/socket.io.js"></script>
    
    <script>
        /**
         * GLOBAL CONFIGURATION & STATE
         */
        const CONFIG = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // State Objects
        let state = {
            localStream: null,
            screenStream: null,
            mediaRecorder: null,
            recordedChunks: [],
            isHost: false,
            isRecording: false,
            isScreenSharing: false,
            roomId: null,
            userName: "User",
            peerConnections: {}, // Store RTCPeerConnections
            dataChannels: {},    // Store Chat Data Channels
            peers: {},           // Store User Metadata
            audioEnabled: true,
            videoEnabled: true
        };

        const socket = io();

        // --- DOM Elements Cache ---
        const els = {
            lobby: document.getElementById('lobby-container'),
            app: document.getElementById('app-container'),
            videoGrid: document.getElementById('video-grid'),
            dominantView: document.getElementById('dominant-view'),
            localVideo: document.getElementById('local-video'),
            previewVideo: document.getElementById('preview-video'),
            chatInput: document.getElementById('chat-input'),
            chatContainer: document.getElementById('chat-messages'),
            participantList: document.getElementById('participants-list')
        };

        /* * =================================================
         * 1. INITIALIZATION & UI NAVIGATION
         * =================================================
         */
        
        function goToStep(step) {
            document.querySelectorAll('.lobby-card').forEach(el => el.classList.add('hidden'));
            document.getElementById(`lobby-step-${step}`).classList.remove('hidden');
        }

        // --- Setup Clock ---
        setInterval(() => {
            document.getElementById('clock-display').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }, 1000);

        // --- Host Flow ---
        async function initHostFlow() {
            const name = document.getElementById('host-name').value.trim();
            const room = document.getElementById('create-room-id').value.trim() || Math.random().toString(36).substring(7);
            
            if(!name) return showToast('Please enter your name', 'error');
            
            state.userName = name;
            state.roomId = room;
            state.isHost = true;
            
            await setupMedia();
            document.getElementById('connection-status').innerText = `Room: ${room} | Host Ready`;
            document.getElementById('connection-status').style.color = 'var(--success)';
            goToStep(4);
        }

        // --- Guest Flow ---
        async function initGuestFlow() {
            const name = document.getElementById('guest-name').value.trim();
            const room = document.getElementById('join-room-id').value.trim();
            
            if(!name || !room) return showToast('Please fill all fields', 'error');

            state.userName = name;
            state.roomId = room;
            state.isHost = false;

            await setupMedia();
            document.getElementById('connection-status').innerText = `Connecting to ${room}...`;
            goToStep(4);
        }

        /* * =================================================
         * 2. MEDIA HANDLING (Camera/Mic)
         * =================================================
         */
        async function setupMedia() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                state.localStream = stream;
                
                // Set to preview
                els.previewVideo.srcObject = stream;
                
                // Populate Settings dropdowns
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioSelect = document.getElementById('audio-input-select');
                const videoSelect = document.getElementById('video-input-select');
                
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `${device.kind} - ${device.deviceId.substring(0,5)}`;
                    if(device.kind === 'audioinput') audioSelect.appendChild(option);
                    else if(device.kind === 'videoinput') videoSelect.appendChild(option);
                });

                return true;
            } catch (err) {
                showToast('Camera/Mic access denied!', 'error');
                console.error(err);
                return false;
            }
        }

        // --- Toggle Buttons (Mic/Cam) ---
        document.getElementById('mic-btn').onclick = toggleMic;
        document.getElementById('pre-mic-btn').onclick = toggleMic;
        
        function toggleMic() {
            const track = state.localStream.getAudioTracks()[0];
            state.audioEnabled = !state.audioEnabled;
            track.enabled = state.audioEnabled;
            
            const icon = state.audioEnabled ? '<i class="fas fa-microphone"></i>' : '<i class="fas fa-microphone-slash"></i>';
            document.getElementById('mic-btn').innerHTML = icon;
            document.getElementById('pre-mic-btn').innerHTML = icon;
            
            document.getElementById('mic-btn').classList.toggle('off-state', !state.audioEnabled);
            document.getElementById('pre-mic-btn').classList.toggle('off', !state.audioEnabled);
            
            // Visual Update in Local Card
            document.getElementById('local-mute-icon').style.display = state.audioEnabled ? 'none' : 'inline-block';
        }

        document.getElementById('cam-btn').onclick = toggleCam;
        document.getElementById('pre-cam-btn').onclick = toggleCam;
        
        function toggleCam() {
            const track = state.localStream.getVideoTracks()[0];
            state.videoEnabled = !state.videoEnabled;
            track.enabled = state.videoEnabled;
            
            const icon = state.videoEnabled ? '<i class="fas fa-video"></i>' : '<i class="fas fa-video-slash"></i>';
            document.getElementById('cam-btn').innerHTML = icon;
            document.getElementById('pre-cam-btn').innerHTML = icon;
            
            document.getElementById('cam-btn').classList.toggle('off-state', !state.videoEnabled);
            document.getElementById('pre-cam-btn').classList.toggle('off', !state.videoEnabled);

            // Toggle Placeholder visibility
            const card = document.getElementById('local-card');
            if(card) {
                card.querySelector('.no-cam-placeholder').style.display = state.videoEnabled ? 'none' : 'flex';
            }
        }

        /* * =================================================
         * 3. JOINING & SOCKET SIGNALING
         * =================================================
         */
        document.getElementById('btn-enter-meeting').onclick = () => {
            // Setup Local Video in Main Stage
            els.localVideo.srcObject = state.localStream;
            
            // Switch UI
            els.lobby.classList.add('hidden');
            els.app.classList.remove('hidden');
            document.getElementById('display-room-id').innerText = state.roomId;
            
            // Host logic vs Guest logic
            if (state.isHost) {
                socket.emit('join-room', { roomId: state.roomId, userName: state.userName, isHost: true });
                addToParticipants(socket.id, state.userName + " (Host)");
            } else {
                // Guests must wait
                showToast('Requesting entry...', 'warning');
                socket.emit('request-entry', { roomId: state.roomId, userName: state.userName });
            }
        };

        // --- Socket Events ---

        // 1. Waiting Room (Host Side)
        socket.on('entry-requested', (data) => {
            if(!state.isHost) return; // Only host sees this
            const modal = document.getElementById('waiting-room-modal');
            document.getElementById('waiting-user-name').innerText = `${data.userName} is requesting to join.`;
            modal.classList.add('open');
            
            // Setup buttons specifically for this request
            document.getElementById('btn-allow-entry').onclick = () => {
                socket.emit('admin-action', { action: 'approve', targetId: data.socketId });
                modal.classList.remove('open');
            };
            document.getElementById('btn-deny-entry').onclick = () => {
                socket.emit('admin-action', { action: 'deny', targetId: data.socketId });
                modal.classList.remove('open');
            };
        });

        // 2. Entry Responses (Guest Side)
        socket.on('entry-approved', () => {
            showToast('Entry Approved!', 'success');
            socket.emit('join-room-final', { roomId: state.roomId, userName: state.userName });
        });
        socket.on('entry-denied', () => {
            alert("The host denied your entry.");
            location.reload();
        });

        // 3. Connection Established
        socket.on('user-connected', (userId, userName) => {
            showToast(`${userName} joined`, 'info');
            state.peers[userId] = { name: userName };
            addToParticipants(userId, userName);
            connectToNewUser(userId, state.localStream);
        });

        socket.on('user-disconnected', (userId) => {
            const name = state.peers[userId] ? state.peers[userId].name : 'User';
            showToast(`${name} left`, 'warning');
            
            // Close Peer Connection
            if(state.peerConnections[userId]) state.peerConnections[userId].close();
            delete state.peerConnections[userId];
            delete state.peers[userId];
            
            // Remove Video Element
            const el = document.getElementById(`wrapper-${userId}`);
            if(el) el.remove();
            
            // Remove from list
            const pItem = document.getElementById(`p-item-${userId}`);
            if(pItem) pItem.remove();
            
            updateParticipantCount();
        });

        /* * =================================================
         * 4. WEBRTC CORE (PeerConnections)
         * =================================================
         */
        function createPeerConnection(userId) {
            const pc = new RTCPeerConnection(CONFIG);
            state.peerConnections[userId] = pc;

            // Add Local Tracks
            state.localStream.getTracks().forEach(track => pc.addTrack(track, state.localStream));

            // Handle ICE Candidates
            pc.onicecandidate = event => {
                if(event.candidate) {
                    socket.emit('candidate', event.candidate, userId);
                }
            };

            // Handle Incoming Stream
            pc.ontrack = event => {
                const stream = event.streams[0];
                
                // If this is a screen share track (usually distinct)
                // Simplified: We assume first video track is cam, if replaced later handled by negotiation
                addRemoteVideo(userId, stream);
            };

            // Setup Data Channel (for Chat)
            pc.ondatachannel = event => {
                const receiveChannel = event.channel;
                receiveChannel.onmessage = (e) => handleDataMessage(e, userId);
                state.dataChannels[userId] = receiveChannel;
            };

            return pc;
        }

        function connectToNewUser(userId) {
            const pc = createPeerConnection(userId);
            
            // Create Data Channel (Caller Side)
            const dataChannel = pc.createDataChannel("chat");
            state.dataChannels[userId] = dataChannel;
            
            pc.createOffer().then(offer => {
                pc.setLocalDescription(offer);
                socket.emit('offer', offer, userId, state.userName);
            });
        }

        // WebRTC Signaling Handlers
        socket.on('offer', async (offer, userId, userName) => {
            state.peers[userId] = { name: userName };
            addToParticipants(userId, userName);
            
            const pc = createPeerConnection(userId);
            await pc.setRemoteDescription(offer);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.emit('answer', answer, userId);
        });

        socket.on('answer', async (answer, userId) => {
            const pc = state.peerConnections[userId];
            if(pc) await pc.setRemoteDescription(answer);
        });

        socket.on('candidate', async (candidate, userId) => {
            const pc = state.peerConnections[userId];
            if(pc) await pc.addIceCandidate(candidate);
        });

        /* * =================================================
         * 5. UI GENERATION (Videos, Participants)
         * =================================================
         */
        function addRemoteVideo(userId, stream) {
            if(document.getElementById(`wrapper-${userId}`)) return;

            const name = state.peers[userId] ? state.peers[userId].name : "Guest";
            
            const wrapper = document.createElement('div');
            wrapper.className = 'video-card';
            wrapper.id = `wrapper-${userId}`;
            
            wrapper.innerHTML = `
                <video id="vid-${userId}" autoplay playsinline></video>
                <div class="no-cam-placeholder" id="placeholder-${userId}">
                    <div class="no-cam-avatar">${name.charAt(0)}</div>
                    <div style="color: var(--text-muted);">Camera Off</div>
                </div>
                <div class="user-info-badge">${name}</div>
            `;
            
            els.videoGrid.appendChild(wrapper);
            const vidEl = document.getElementById(`vid-${userId}`);
            vidEl.srcObject = stream;
            
            // Handle Stream active/inactive for placeholder
            stream.getVideoTracks()[0].onmute = () => {
                document.getElementById(`placeholder-${userId}`).style.display = 'flex';
            };
            stream.getVideoTracks()[0].onunmute = () => {
                document.getElementById(`placeholder-${userId}`).style.display = 'none';
            };
        }

        function addToParticipants(id, name) {
            if(document.getElementById(`p-item-${id}`)) return;
            
            const item = document.createElement('div');
            item.className = 'participant-item';
            item.id = `p-item-${id}`;
            item.innerHTML = `
                <div class="p-name">
                    <div class="p-avatar">${name.charAt(0)}</div>
                    ${name}
                </div>
                <div class="p-actions">
                    ${state.isHost && id !== socket.id ? `<button onclick="kickUser('${id}')" title="Kick"><i class="fas fa-ban"></i></button>` : ''}
                </div>
            `;
            els.participantList.appendChild(item);
            updateParticipantCount();
        }

        function updateParticipantCount() {
            const count = els.participantList.children.length;
            document.getElementById('participant-count').innerText = count;
        }

        /* * =================================================
         * 6. SCREEN SHARING (Host Features)
         * =================================================
         */
        document.getElementById('screen-btn').onclick = async () => {
            if(state.isScreenSharing) {
                stopScreenShare();
            } else {
                startScreenShare();
            }
        };

        async function startScreenShare() {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                state.screenStream = stream;
                
                const screenTrack = stream.getVideoTracks()[0];
                
                // Replace track for all peers
                for (let id in state.peerConnections) {
                    const pc = state.peerConnections[id];
                    const sender = pc.getSenders().find(s => s.track.kind === 'video');
                    if(sender) sender.replaceTrack(screenTrack);
                }

                // Notify Server
                socket.emit('start-screen-share', state.roomId);
                
                // Local UI Update
                updateScreenShareUI(true, stream, "You are");
                
                // Listen for stop via browser UI
                screenTrack.onended = () => stopScreenShare();
                
                state.isScreenSharing = true;
                document.getElementById('screen-btn').classList.add('active-feature');

            } catch (err) {
                console.error("Screen share cancelled", err);
            }
        }

        function stopScreenShare() {
            state.screenStream.getTracks().forEach(t => t.stop());
            const camTrack = state.localStream.getVideoTracks()[0];
            
            for (let id in state.peerConnections) {
                const pc = state.peerConnections[id];
                const sender = pc.getSenders().find(s => s.track.kind === 'video');
                if(sender) sender.replaceTrack(camTrack);
            }

            socket.emit('stop-screen-share', state.roomId);
            updateScreenShareUI(false);
            
            state.isScreenSharing = false;
            document.getElementById('screen-btn').classList.remove('active-feature');
        }

        // Remote Screen Share Handlers
        socket.on('screen-share-started', (userId) => {
            // Find that user's video element stream
            const vid = document.getElementById(`vid-${userId}`);
            if(vid && vid.srcObject) {
                const userName = state.peers[userId] ? state.peers[userId].name : 'User';
                updateScreenShareUI(true, vid.srcObject, userName);
            }
        });

        socket.on('screen-share-stopped', () => {
            updateScreenShareUI(false);
        });

        function updateScreenShareUI(isActive, stream = null, sharerName = "") {
            if(isActive) {
                els.videoGrid.classList.add('hidden');
                els.dominantView.style.display = 'block';
                document.getElementById('dominant-video').srcObject = stream;
                document.getElementById('sharing-user-name').innerText = sharerName;
            } else {
                els.videoGrid.classList.remove('hidden');
                els.dominantView.style.display = 'none';
                document.getElementById('dominant-video').srcObject = null;
            }
        }

        /* * =================================================
         * 7. CHAT & DATA CHANNEL SYSTEM
         * =================================================
         */
        function handleDataMessage(event, senderId) {
            const msg = event.data;
            // Differentiate between Chat and other data if needed
            // For now, assume string is chat
            const senderName = state.peers[senderId] ? state.peers[senderId].name : "Unknown";
            addChatMessage(senderName, msg, false);
            
            // Show Badge
            const badge = document.getElementById('chat-badge');
            if(document.getElementById('sidebar-panel').style.display !== 'flex') {
                badge.style.display = 'block';
                badge.innerText = parseInt(badge.innerText) + 1;
            }
        }

        function sendMessage() {
            const text = els.chatInput.value.trim();
            if(!text) return;

            addChatMessage("You", text, true);
            
            // Send via Data Channel to all connected peers
            for (let id in state.dataChannels) {
                const channel = state.dataChannels[id];
                if(channel.readyState === 'open') {
                    channel.send(text);
                }
            }
            
            els.chatInput.value = '';
        }

        els.chatInput.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') sendMessage();
        });

        function addChatMessage(sender, text, isLocal) {
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${isLocal ? 'local' : 'remote'}`;
            bubble.innerHTML = `
                <div class="chat-meta">${sender} â€¢ ${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                ${text}
            `;
            els.chatContainer.appendChild(bubble);
            els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
        }

        /* * =================================================
         * 8. RECORDING LOGIC (MediaRecorder)
         * =================================================
         */
        document.getElementById('record-btn').onclick = () => {
            if(state.isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        };

        function startRecording() {
            // Record Screen Share + Audio
            // If screen sharing is active, record that. Else record local stream (demo limit)
            const streamToRecord = state.isScreenSharing ? state.screenStream : state.localStream;
            
            state.recordedChunks = [];
            state.mediaRecorder = new MediaRecorder(streamToRecord, { mimeType: 'video/webm; codecs=vp9' });
            
            state.mediaRecorder.ondataavailable = event => {
                if(event.data.size > 0) state.recordedChunks.push(event.data);
            };

            state.mediaRecorder.onstop = saveRecording;
            state.mediaRecorder.start();
            state.isRecording = true;
            
            document.getElementById('record-btn').classList.add('off-state'); // Red
            document.getElementById('recording-indicator').classList.remove('hidden');
            showToast('Recording Started', 'success');
        }

        function stopRecording() {
            state.mediaRecorder.stop();
            state.isRecording = false;
            document.getElementById('record-btn').classList.remove('off-state');
            document.getElementById('recording-indicator').classList.add('hidden');
        }

        function saveRecording() {
            const blob = new Blob(state.recordedChunks, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `meeting-recording-${Date.now()}.webm`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            showToast('Recording Saved!', 'info');
        }

        /* * =================================================
         * 9. UTILITIES & REACTIONS
         * =================================================
         */
        
        // Settings Modal
        document.getElementById('pre-set-btn').onclick = () => {
            document.getElementById('settings-modal').classList.add('open');
        };
        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('open');
        }
        async function saveSettings() {
            const audioId = document.getElementById('audio-input-select').value;
            const videoId = document.getElementById('video-input-select').value;
            
            // Get new stream
            const newStream = await navigator.mediaDevices.getUserMedia({
                audio: { deviceId: { exact: audioId } },
                video: { deviceId: { exact: videoId } }
            });
            
            // Replace tracks in Peer Connections
            const videoTrack = newStream.getVideoTracks()[0];
            const audioTrack = newStream.getAudioTracks()[0];
            
            for(let id in state.peerConnections) {
                const pc = state.peerConnections[id];
                const vSender = pc.getSenders().find(s => s.track.kind === 'video');
                const aSender = pc.getSenders().find(s => s.track.kind === 'audio');
                if(vSender) vSender.replaceTrack(videoTrack);
                if(aSender) aSender.replaceTrack(audioTrack);
            }
            
            state.localStream = newStream;
            els.localVideo.srcObject = newStream;
            els.previewVideo.srcObject = newStream;
            
            closeSettings();
            showToast('Devices Updated', 'success');
        }

        // Sidebar Toggle
        function toggleSidebar() {
            const panel = document.getElementById('sidebar-panel');
            const isHidden = panel.style.display === 'none' || panel.style.display === '';
            panel.style.display = isHidden ? 'flex' : 'none';
            
            // Clear badge
            if(isHidden) {
                document.getElementById('chat-badge').innerText = '0';
                document.getElementById('chat-badge').style.display = 'none';
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
            
            if(tab === 'chat') {
                document.getElementById('chat-container').classList.remove('hidden');
                document.getElementById('participants-list').classList.add('hidden');
            } else {
                document.getElementById('chat-container').classList.add('hidden');
                document.getElementById('participants-list').classList.remove('hidden');
            }
        }

        // Reactions
        document.getElementById('reaction-btn').onclick = () => {
            // Broadcast reaction logic here (via Data Channel)
            showReaction('ðŸ‘');
            // Mock sending to peers
            for (let id in state.dataChannels) {
                 if(state.dataChannels[id].readyState === 'open') state.dataChannels[id].send("REACTION:ðŸ‘");
            }
        };

        function showReaction(emoji) {
            const container = document.getElementById('reactions-container');
            const el = document.createElement('div');
            el.innerText = emoji;
            el.style.position = 'absolute';
            el.style.left = Math.random() * 80 + 10 + '%';
            el.style.bottom = '0px';
            el.style.fontSize = '2rem';
            el.style.animation = 'floatUp 2s ease-out forwards';
            container.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        // Add CSS for floatUp
        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes floatUp {
                0% { transform: translateY(0) scale(1); opacity: 1; }
                100% { transform: translateY(-150px) scale(1.5); opacity: 0; }
            }
            @keyframes blink { 50% { opacity: 0; } }
        `;
        document.head.appendChild(styleSheet);

        // Toast System
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = message;
            
            if(type === 'error') toast.style.borderLeftColor = 'var(--danger)';
            if(type === 'success') toast.style.borderLeftColor = 'var(--success)';
            
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function copyRoomLink() {
            const url = `${window.location.origin}/?room=${state.roomId}`;
            navigator.clipboard.writeText(url);
            showToast('Link copied to clipboard!', 'success');
        }

        function leaveMeeting() {
            if(confirm("Are you sure you want to leave?")) {
                window.location.href = '/';
            }
        }

        // Pip Toggle
        async function togglePip() {
            const video = document.getElementById('dominant-video');
            if (document.pictureInPictureElement) {
                await document.exitPictureInPicture();
            } else if (video.readyState === 4) {
                await video.requestPictureInPicture();
            }
        }

    </script>
</body>
</html>